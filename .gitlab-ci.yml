image: iqrfsdk/iqrf-gateway-webapp:tests-buster

stages:
  - build-docker
  - test
  - coding-style
  - build-package
  - deploy-docs

variables:
  COMPOSER_CACHE_DIR: temp/composer/cache

cache:
  paths:
    - temp/composer/cache

.test_template: &test_template
  stage: test
  retry: 2

.ssh_template: &ssh_template
  stage: deploy-docs
  before_script:
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

.docker_template: &docker_template
  image: docker:stable
  services:
    - docker:dind
  stage: build-docker
  before_script:
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  script:
    - docker build -f $DOCKER_FILE -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker push $DOCKER_IMAGE:$DOCKER_TAG

build-docker:latest-amd64:
  only:
    changes:
      - .gitlab-ci.yml
      - docker/latest/amd64.Dockerfile
  variables:
    DOCKER_FILE: docker/latest/amd64.Dockerfile
    DOCKER_IMAGE: iqrf/iqrf-gateway-webapp
    DOCKER_TAG: latest-amd64
  <<: *docker_template

build-docker:latest-rpi:
  only:
    changes:
      - .gitlab-ci.yml
      - docker/latest/rpi.Dockerfile
  variables:
    DOCKER_FILE: docker/latest/rpi.Dockerfile
    DOCKER_IMAGE: iqrf/iqrf-gateway-webapp
    DOCKER_TAG: latest-rpi
  <<: *docker_template

build-docker:stable-amd64:
  only:
    changes:
      - .gitlab-ci.yml
      - docker/stable/amd64.Dockerfile
  variables:
    DOCKER_FILE: docker/stable/amd64.Dockerfile
    DOCKER_IMAGE: iqrf/iqrf-gateway-webapp
    DOCKER_TAG: stable-amd64
  <<: *docker_template

build-docker:stable-rpi:
  only:
    changes:
      - .gitlab-ci.yml
      - docker/stable/rpi.Dockerfile
  variables:
    DOCKER_FILE: docker/stable/rpi.Dockerfile
    DOCKER_IMAGE: iqrf/iqrf-gateway-webapp
    DOCKER_TAG: stable-rpi
  <<: *docker_template

build-docker:tests-buster:
  only:
    changes:
      - .gitlab-ci.yml
      - docker/tests/buster.Dockerfile
  variables:
    DOCKER_FILE: docker/tests/buster.Dockerfile
    DOCKER_IMAGE: iqrfsdk/iqrf-gateway-webapp
    DOCKER_TAG: tests-buster
  <<: *docker_template

build-docker:tests-stretch:
  only:
    changes:
      - .gitlab-ci.yml
      - docker/tests/stretch.Dockerfile
  variables:
    DOCKER_FILE: docker/tests/stretch.Dockerfile
    DOCKER_IMAGE: iqrfsdk/iqrf-gateway-webapp
    DOCKER_TAG: tests-stretch
  <<: *docker_template

test:php7.1:
  image: iqrfsdk/iqrf-gateway-webapp:tests-stretch
  before_script:
    - update-alternatives --set php /usr/bin/php7.1
    - composer install --no-progress
  script:
    - vendor/bin/tester -p phpdbg7.1 -c ./tests/php.ini -s ./tests
    - 'for i in $(find ./tests -name \*.actual); do echo "--- $i"; cat $i; echo; echo; done'
  <<: *test_template

test:php7.2:
  before_script:
    - update-alternatives --set php /usr/bin/php7.2
    - composer install --no-progress
  script:
    - vendor/bin/tester -p phpdbg7.2 -c ./tests/php.ini -s ./tests
    - 'for i in $(find ./tests -name \*.actual); do echo "--- $i"; cat $i; echo; echo; done'
  <<: *test_template

test:php7.3:
  allow_failure: true
  before_script:
    - update-alternatives --set php /usr/bin/php7.3
    - composer install --no-progress
  script:
    - vendor/bin/tester -p phpdbg7.3 -c ./tests/php.ini -s ./tests
    - 'for i in $(find ./tests -name \*.actual); do echo "--- $i"; cat $i; echo; echo; done'
  <<: *test_template

coverage:
  before_script:
    - update-alternatives --set php /usr/bin/php7.3
    - composer install --no-progress
  script:
    - vendor/bin/tester -p phpdbg -c ./tests/php.ini -o none --coverage ./coverage.html --coverage-src ./app ./tests
  artifacts:
    paths:
      - 'coverage.html'
    expire_in: 2 weeks
  <<: *test_template

coding-style:
  stage: coding-style
  before_script:
    - update-alternatives --set php /usr/bin/php7.2
    - composer install-cs
  script:
    - composer check-cs

phpstan:
  stage: coding-style
  before_script:
    - update-alternatives --set php /usr/bin/php7.2
    - composer install --no-progress
  script:
    - composer phpstan

build-package:
  stage: build-package
  before_script:
    - update-alternatives --set php /usr/bin/php7.2
    - git checkout -B "$CI_COMMIT_REF_NAME" "$CI_COMMIT_SHA"
  script:
    - gbp dch -a -S --snapshot-number="$CI_PIPELINE_ID"
    - dpkg-buildpackage -b -rfakeroot -us -uc -tc
    - cp ../iqrf-gateway-webapp_*all.deb .
  artifacts:
    paths:
      - 'iqrf-gateway-webapp_*all.deb'
    expire_in: 2 weeks

deploy-api-docs:
  script:
    - curl -L https://github.com/phpDocumentor/phpDocumentor2/releases/download/v3.0.0-alpha.3/phpDocumentor.phar -o phpDocumentor.phar
    - curl -L https://github.com/phpDocumentor/phpDocumentor2/releases/download/v3.0.0-alpha.3/phpDocumentor.phar.pubkey -o phpDocumentor.phar.pubkey
    - php phpDocumentor.phar
    - rsync -hrvz --delete -e ssh docs/api/ www-deploy@iqrfsdk.org:/data/nginx/apidocs/iqrf-gateway-webapp/
  <<: *ssh_template

deploy-user-docs:
  script:
    - cd docs/; make html
    - rsync -hrvz --delete -e ssh build/html/ www-deploy@iqrfsdk.org:/data/nginx/docs/iqrf-gateway-webapp/
  <<: *ssh_template
