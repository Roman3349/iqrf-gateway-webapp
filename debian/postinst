#!/bin/sh
# postinst script for iqrf-gateway-webapp

set -e

nginx_virtualhost_install() {
	nginx_virtualhost_old_remove
	if [ -e /etc/nginx/sites-available/iqrf-gateway-webapp.localhost ] ; then
		rm /etc/nginx/sites-available/iqrf-gateway-webapp.localhost
	fi
	ln -s /etc/iqrf-gateway-webapp/nginx/iqrf-gateway-webapp_php7-3.localhost /etc/nginx/sites-available/iqrf-gateway-webapp.localhost
	if [ ! -L /etc/nginx/sites-enabled/iqrf-gateway-webapp.localhost ] ; then
		ln -s /etc/nginx/sites-available/iqrf-gateway-webapp.localhost /etc/nginx/sites-enabled/iqrf-gateway-webapp.localhost
	fi
	if deb-systemd-invoke is-enabled nginx.service ; then
		deb-systemd-invoke reload nginx.service
	fi
}

nginx_virtualhost_old_remove() {
	if [ -e /etc/nginx/sites-enabled/default ] ; then
		rm /etc/nginx/sites-enabled/default
	fi
	if [ -e /etc/nginx/sites-available/iqrf-daemon-webapp.localhost ] ; then
		rm /etc/nginx/sites-available/iqrf-daemon-webapp.localhost
	fi
	if [ -e /etc/nginx/sites-enabled/iqrf-daemon-webapp.localhost ] ; then
		rm /etc/nginx/sites-enabled/iqrf-daemon-webapp.localhost
	fi
	if [ -e /etc/nginx/sites-available/iqrf-gateway-webapp.localhost ] ; then
		rm /etc/nginx/sites-available/iqrf-gateway-webapp.localhost
	fi
}

openssl_create_ca() {
	if [ ! -f /etc/iqrf-gateway-webapp/certs/cert.pem ] || [ ! -f /etc/iqrf-gateway-webapp/certs/privkey.pem ] ; then
		openssl req -new -x509 -days 3650 \
			-subj "/C=CZ/ST=Hradec Kralove Region/L=Jicin/O=IQRF Tech s.r.o." \
			-newkey rsa:4096 -nodes -keyout /etc/iqrf-gateway-webapp/certs/privkey.pem \
			-out /etc/iqrf-gateway-webapp/certs/cert.pem
		chmod 600 /etc/iqrf-gateway-webapp/certs/*.pem
	fi
}

webapp_remove_cache() {
	if [ -d /var/cache/iqrf-gateway-webapp/cache ] ; then
		rm -rf /var/cache/iqrf-gateway-webapp/cache
	fi
}

webapp_remove_old_dirs() {
	if [ -d /usr/share/iqrf-gateway-webapp/log ] ; then
		mv /usr/share/iqrf-gateway-webapp/log/* /var/log/iqrf-gateway-webapp/
		rm -rf /usr/share/iqrf-gateway-webapp/log
	fi
	if [ -d /usr/share/iqrf-gateway-webapp/temp ] ; then
		rm -rf /usr/share/iqrf-gateway-webapp/temp
	fi
}

if [ "$1" = "configure" ]; then
	openssl_create_ca
	nginx_virtualhost_install
	webapp_remove_cache
	webapp_remove_old_dirs
fi
