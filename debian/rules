#!/usr/bin/make -f

ROOT_DIR=debian/iqrf-gateway-webapp

CACHE_DIR=${ROOT_DIR}/var/cache/iqrf-gateway-webapp/
LOG_DIR=${ROOT_DIR}/var/log/iqrf-gateway-webapp/
VENDOR_DIR=${ROOT_DIR}/usr/share/iqrf-gateway-webapp/vendor

%:
	dh $@ --with apache2,phpcomposer

override_dh_fixperms:
	dh_fixperms
	chown -R www-data:www-data ${ROOT_DIR}/usr/share/iqrf-gateway-webapp/
	chown -R www-data:www-data ${CACHE_DIR}
	chown -R www-data:www-data ${LOG_DIR}
	chmod -R 644 ${LOG_DIR}
	chmod -R 644 ${CACHE_DIR}
	chmod 755 ${LOG_DIR}
	chmod 755 ${CACHE_DIR}

override_dh_auto_build:
	# Set current git commit
	sed -i "s/\t\"commit\"\: .*/\t\"commit\"\: \"`git rev-parse --verify HEAD`\",/" version.json
	# Set GitLab CI pipeline ID
	sed -i "s/\t\"pipeline\"\: .*/\t\"pipeline\"\: \"${CI_PIPELINE_ID}\"/" version.json
	# Install PHP dependencies
	composer install --no-dev

override_dh_install:
	dh_install
	# Delete documentation
	find ${VENDOR_DIR} -type f -name "AUTHORS*" -delete
	find ${VENDOR_DIR} -type f -name "LICENSE*" -delete
	find ${VENDOR_DIR} -type f -name "README*" -delete
	find ${VENDOR_DIR} -type d -name -regex ".*/\(\.\)?[Dd]oc\(s\)?" -print0 | xargs -0 rm -rf
	# Delete composer files
	find ${VENDOR_DIR} -type f -name "composer.json" -delete
	# Delete bower files
	find ${VENDOR_DIR} -type f -name "bower.json" -delete
	# Delete NPM files
	find ${VENDOR_DIR} -type f -name ".npmignore" -delete
	find ${VENDOR_DIR} -type f -name "package.json" -delete
	# Delete ESLint files
	find ${VENDOR_DIR} -type f -name ".eslintrc.js" -delete
	# Delete git files
	find ${VENDOR_DIR} -type d -name ".git" -print0 | xargs -0 rm -rf
	find ${VENDOR_DIR} -type f -name ".gitattributes" -delete
	find ${VENDOR_DIR} -type f -name ".gitignore" -delete
	find ${VENDOR_DIR} -type f -name ".gitmodules" -delete
	# Delete CI files
	find ${VENDOR_DIR} -type f -regex ".*/\(appveyor\|\.gitlab-ci\|\.scrutinizer\|\.travis\)\.yml" -delete
	# Delete PHP Coding Standards Fixer files
	find ${VENDOR_DIR} -type f -regex ".*/\.php_cs\(\.dist\)?" -delete
	# Delete PHPStan files
	find ${VENDOR_DIR} -type f -name "phpstan.neon" -delete
	# Delete PHP_CodeSniffer files
	find ${VENDOR_DIR} -type f -name "ruleset.xml" -delete
	# Delete PHPUnit files
	find ${VENDOR_DIR} -type f -regex ".*/phpunit\.xml\(\.dist\)?" -delete
	# Delete examples
	find ${VENDOR_DIR} -type d -name "demo" -print0 | xargs -0 rm -rf
	find ${VENDOR_DIR} -type d -regex ".*/[Ee]xample\(s\)?/*" -print0 | xargs -0 rm -rf
	# Delete tests
	find ${VENDOR_DIR} -type d -regex ".*/[Tt]est\(s\)?/*" -print0 | xargs -0 rm -rf
	# Delete binaries
	find ${VENDOR_DIR} -type d -name "bin" -print0 | xargs -0 rm -rf
	find ${VENDOR_DIR} -type d -name "tools" -print0 | xargs -0 rm -rf
	find ${VENDOR_DIR} -type f -name "*.sh" -delete
	find ${VENDOR_DIR} -type f -name "Makefile" -delete
	find ${VENDOR_DIR} -type f -print0 | xargs -0 chmod -x
	# Delete empty directories
	find ${VENDOR_DIR} -type d -empty -delete
